<% nodes.forEach(function (node) { const authorName=node.author_name || (node.author && node.author.name) || 'Unknown' ;
    const createdAt=node.created_at || node.createdAt; const id=node.id || node.comment_id; const
    hasChildren=node.children && node.children.length> 0;
    const indentClass = level ? 'comment--indented' : '';
    const borderClass = level ? 'comment--border' : '';
    %>
    <li class="list-group-item comment <%= indentClass %> <%= borderClass %>" data-comment-id="<%= id %>">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <strong>
                    <%= authorName %>
                </strong>
                <span class="text-muted"> Â· <%= new Date(createdAt).toLocaleString() %></span>
            </div>
            <button class="btn btn-sm btn-outline-secondary" data-action="toggle-reply"
                data-id="<%= id %>">Reply</button>
        </div>

        <p class="mt-2 mb-2">
            <%= node.body %>
        </p>

        <!-- Inline reply form (hidden by default via Bootstrap's d-none) -->
        <form id="reply-form-<%= id %>" action="/thread/<%= threadId %>/comment" method="POST" class="mt-2 d-none">
            <input type="hidden" name="parent_comment_id" value="<%= id %>">
            <div class="mb-2">
                <textarea name="body" class="form-control" rows="2" placeholder="Write a reply..." required></textarea>
            </div>
            <button type="submit" class="btn btn-sm btn-primary">Post reply</button>
        </form>

        <% if (hasChildren) { %>
            <ul class="list-group mt-2">
                <%- include('comment-item', { nodes: node.children, threadId, level: level + 1 }) %>
            </ul>
            <% } %>
    </li>
    <% }); %>