<%- include('templates/header') %>

<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="h4 mb-0">Welcome, <%= displayName %></h1>
  <a href="/createThread" class="btn btn-primary">Create Thread</a>
</div>

<h2 class="h5 mb-3">Most Popular</h2>

<% if (!popularThreads || popularThreads.length === 0) { %>
  <div class="alert alert-secondary">No popular threads yet.</div>
<% } else { %>
  <div class="row g-4">
    <% popularThreads.forEach(t => { %>
      <div class="col-12 col-lg-4">
        <div class="card shadow-sm h-100">
          <div class="card-body d-flex flex-column">
            <h3 class="h5 card-title mb-1">
              <a href="/thread?threadId=<%= t.thread_id %>" class="text-decoration-none"><%= t.title %></a>
            </h3>

            <p class="text-muted mb-2 d-flex align-items-center gap-2">
              <img src="<%= t.owner_profile_image || 'https://via.placeholder.com/20' %>"
                   alt="owner avatar" class="rounded" width="20" height="20">
              <span>by <strong><%= t.owner_name %></strong> Â· <%= new Date(t.created_at).toLocaleString() %></span>
            </p>

            <p class="card-text flex-grow-1 thread-snippet">
              <%
                const rawP = (t.body || '');
                const normalizedP = rawP.replace(/\r\n/g, '\n').replace(/^[\t ]+/gm, '').trim();
                const shortP = normalizedP.length > 200 ? normalizedP.slice(0, 200) + 'â€¦' : normalizedP;
              %>
              <%= shortP %>
            </p>

            <div class="d-flex justify-content-between align-items-center mt-2">
              <div class="d-flex gap-2">
                <span class="badge bg-light text-dark">ğŸ‘ï¸ <%= t.views_count || 0 %></span>
                <span class="badge bg-light text-dark">ğŸ’¬ <%= t.comments_count || 0 %></span>
                <span class="badge bg-light text-dark">â™¥ <%= t.likes_count || 0 %></span>
              </div>
              <a href="/thread?threadId=<%= t.thread_id %>" class="btn btn-outline-primary btn-sm">Open</a>
            </div>

          </div>
        </div>
      </div>
    <% }) %>
  </div>
<% } %>

<hr class="my-4">

<h2 class="h5 mb-3">Most Recent Threads</h2>

<% if (!recentThreads || recentThreads.length === 0) { %>
  <div class="alert alert-secondary">No threads yet. Be the first to post.</div>
<% } else { %>
  <div class="row g-4">
    <% recentThreads.forEach(t => { %>
      <div class="col-12 col-lg-4">
        <div class="card shadow-sm h-100">
          <div class="card-body d-flex flex-column">
            <h3 class="h5 card-title mb-1">
              <a href="/thread?threadId=<%= t.thread_id %>" class="text-decoration-none"><%= t.title %></a>
            </h3>

            <p class="text-muted mb-2 d-flex align-items-center gap-2">
              <img src="<%= t.owner_profile_image || 'https://via.placeholder.com/20' %>"
                   alt="owner avatar" class="rounded" width="20" height="20">
              <span>by <strong><%= t.owner_name %></strong> Â· <%= new Date(t.created_at).toLocaleString() %></span>
            </p>

            <p class="card-text flex-grow-1 thread-snippet">
              <%
                const raw = (t.body || '');
                const normalized = raw.replace(/\r\n/g, '\n').replace(/^[\t ]+/gm, '').trim();
                const short = normalized.length > 200 ? normalized.slice(0, 200) + 'â€¦' : normalized;
              %>
              <%= short %>
            </p>

            <div class="d-flex justify-content-between align-items-center mt-2">
              <div class="d-flex gap-2">
                <span class="badge bg-light text-dark">ğŸ‘ï¸ <%= t.views_count || 0 %></span>
                <span class="badge bg-light text-dark">ğŸ’¬ <%= t.comments_count || 0 %></span>
                <span class="badge bg-light text-dark">â™¥ <%= t.likes_count || 0 %></span>
              </div>
              <a href="/thread?threadId=<%= t.thread_id %>" class="btn btn-outline-primary btn-sm">Open</a>
            </div>

          </div>
        </div>
      </div>
    <% }) %>
  </div>
<% } %>

<hr class="my-4">

<h2 class="h5 mb-3">Search</h2>

<form class="mb-3" action="/home" method="GET">
  <div class="input-group">
    <input type="text" name="q" class="form-control" placeholder="Search comments and threads" value="<%= q || '' %>">
    <button class="btn btn-primary" type="submit">Search</button>
  </div>
</form>

<% if (typeof q !== 'undefined' && q && (!searchResults || searchResults.length === 0)) { %>
  <p class="text-muted">No results.</p>
<% } %>

<% if (searchResults && searchResults.length > 0) { %>
  <div class="row g-4">
    <% searchResults.forEach(t => { %>  <!-- reuse same card fields -->
      <div class="col-12 col-lg-4">
        <div class="card shadow-sm h-100">
          <div class="card-body d-flex flex-column">
            <h3 class="h5 card-title mb-1">
              <a href="/thread?threadId=<%= t.thread_id %>" class="text-decoration-none"><%= t.title %></a>
            </h3>

            <p class="text-muted mb-2 d-flex align-items-center gap-2">
              <img src="<%= t.owner_profile_image || 'https://via.placeholder.com/20' %>"
                   alt="owner avatar" class="rounded" width="20" height="20">
              <span>by <strong><%= t.owner_name %></strong> Â· <%= new Date(t.created_at).toLocaleString() %></span>
            </p>

            <p class="card-text flex-grow-1 thread-snippet">
              <%
                const rawS = (t.body || '');
                const normalizedS = rawS.replace(/\r\n/g, '\n').replace(/^[\t ]+/gm, '').trim();
                const shortS = normalizedS.length > 200 ? normalizedS.slice(0, 200) + 'â€¦' : normalizedS;
              %>
              <%= shortS %>
            </p>

            <div class="d-flex justify-content-between align-items-center mt-2">
              <div class="d-flex gap-2">
                <span class="badge bg-light text-dark">ğŸ‘ï¸ <%= t.views_count || 0 %></span>
                <span class="badge bg-light text-dark">ğŸ’¬ <%= t.comments_count || 0 %></span>
                <span class="badge bg-light text-dark">â™¥ <%= t.likes_count || 0 %></span>
              </div>
              <a href="/thread?threadId=<%= t.thread_id %>" class="btn btn-outline-primary btn-sm">Open</a>
            </div>

          </div>
        </div>
      </div>
    <% }) %>
  </div>
<% } %>

<%- include('templates/footer') %>
